T2.7.3 â€” GÃ¼nler (DailyRecord) iÃ§in Tombstone DesteÄŸi

Durum: TAMAMLANDI

ğŸ¯ AmaÃ§

Mevcut yapÄ±da gÃ¼nlÃ¼k kayÄ±tlar silindiÄŸinde hard delete yapÄ±lÄ±yordu.
Bu yaklaÅŸÄ±m:

- Offline silme senaryolarÄ±nda cloud'a iletilememe riskine,
- Ä°leride multi-device sync problemlerine,
- KoÃ§ tarafÄ±nda tutarsÄ±z metriklere

yol aÃ§abilirdi.

Bu ticket ile ExamRecord tarafÄ±nda kullanÄ±lan tombstone yaklaÅŸÄ±mÄ± DailyRecord'a da uygulandÄ±.

ğŸ§© Kapsam

- DailyRecord modeline tombstone alanlarÄ± eklenmesi
- Local state / storage katmanÄ±nÄ±n buna uyarlanmasÄ±
- Supabase tarafÄ±nda is_deleted desteÄŸi
- Sync mantÄ±ÄŸÄ±nÄ±n delete yerine tombstone upsert'e Ã§evrilmesi
- TÃ¼m selector'larda `!isDeleted` filtresi
- Yeni Ã¶zellik eklenmedi, yalnÄ±zca silme davranÄ±ÅŸÄ± deÄŸiÅŸti.

### Uygulama KararlarÄ± (Plan Ticket'tan Sapmalar)

- **DailyRecordInput tipi eklendi**: `upsertRecord` fonksiyonu `DailyRecordInput` (tombstone alanlarÄ± olmadan) kabul eder, tombstone alanlarÄ±nÄ± kendisi set eder. Bu sayede Ã§aÄŸÄ±ran taraflar (HomeScreen, WeekScreen, Onboarding2Screen) deÄŸiÅŸmeden Ã§alÄ±ÅŸÄ±r.
- **Tip tanÄ±mÄ± `ritim/state/records.tsx`'te kaldÄ±**: AyrÄ± `types/record.ts` dosyasÄ± oluÅŸturulmadÄ±, mevcut yapÄ± korundu.
- **`deleteRecordFromCloud` fonksiyonu tamamen silindi**: ArtÄ±k hiÃ§bir yerde kullanÄ±lmÄ±yor, `syncRecord` ile tombstone upsert yapÄ±lÄ±yor.
- **`created_at` kolonu migration ile eklendi**: Tablo zaten `updated_at` kolonuna sahipti, sadece `is_deleted`, `deleted_at`, `created_at` eklendi.

ğŸ›  UYGULANAN TEKNÄ°K TASARIM

## 1) Type GÃ¼ncellemesi

Dosya: `ritim/state/records.tsx`

```typescript
export type DailyRecord = {
  date: string          // YYYY-MM-DD
  trackId: TrackId
  focusMinutes: number
  activityType: ActivityType
  questionCount?: number
  subjectBreakdown?: Record<string, number>

  // Tombstone alanlarÄ±
  isDeleted: boolean
  deletedAtMs?: number | null
  createdAtMs: number
  updatedAtMs: number
}

// Ã‡aÄŸÄ±ran taraflar iÃ§in sadece data alanlarÄ±
export type DailyRecordInput = Omit<DailyRecord, 'isDeleted' | 'deletedAtMs' | 'createdAtMs' | 'updatedAtMs'>
```

## 2) Reducer GÃ¼ncellemesi

Dosya: `ritim/state/records.tsx`

`remove` action â†’ `tombstone` action olarak deÄŸiÅŸti:

```typescript
case 'tombstone': {
  const { trackId, date, deletedAtMs } = action.payload;
  const key = makeRecordKey(trackId, date);
  const existing = state.recordsByKey[key];
  if (!existing) return state;
  return {
    ...state,
    recordsByKey: {
      ...state.recordsByKey,
      [key]: {
        ...existing,
        isDeleted: true,
        deletedAtMs,
        updatedAtMs: deletedAtMs,
      },
    },
  };
}
```

## 3) removeRecord â†’ Tombstone + Sync

```typescript
const removeRecord = useCallback(
  (trackId: TrackId, date: string) => {
    const now = Date.now();
    dispatch({ type: 'tombstone', payload: { trackId, date, deletedAtMs: now } });
    const existing = state.recordsByKey[makeRecordKey(trackId, date)];
    if (existing && shouldSync(date, settings.coachConnected, session)) {
      const tombstone: DailyRecord = {
        ...existing,
        isDeleted: true,
        deletedAtMs: now,
        updatedAtMs: now,
      };
      syncRecord(tombstone, session!).catch(console.warn);
    }
  },
  [state.recordsByKey, settings.coachConnected, session],
);
```

## 4) upsertRecord â†’ Tombstone Restore

```typescript
const upsertRecord = useCallback(
  (record: DailyRecordInput) => {
    const now = Date.now();
    const key = makeRecordKey(record.trackId, record.date);
    const existing = state.recordsByKey[key];
    const merged: DailyRecord = {
      ...record,
      isDeleted: false,
      deletedAtMs: null,
      createdAtMs: existing?.createdAtMs ?? now,
      updatedAtMs: now,
    };
    dispatch({ type: 'upsert', payload: merged });
    if (shouldSync(merged.date, settings.coachConnected, session)) {
      syncRecord(merged, session!).catch(console.warn);
    }
  },
  [state.recordsByKey, settings.coachConnected, session],
);
```

## 5) Selector Filtreleri

TÃ¼m getter'lara `!isDeleted` filtresi eklendi:

- `records` memo â†’ `.filter(r => !r.isDeleted)` eklendi
- `getRecord` â†’ `record?.isDeleted ? undefined : record`
- `selectTodayRecord` â†’ aynÄ± filtre
- `selectWeekDots` â†’ `Boolean(record && !record.isDeleted)`
- `selectHasAnyRecords` â†’ `.some(r => !r.isDeleted)` / `.some(r => r.trackId === trackId && !r.isDeleted)`
- `getTrackRange` â†’ `if (record.isDeleted) continue`
- `getTrackStreak` â†’ `if (!streakRecord || streakRecord.isDeleted) break`
- `listRecordsByTrack` â†’ `records` zaten filtrelenmiÅŸ (memo'da)

## 6) Storage Normalization

Dosya: `ritim/lib/storage/recordsStorage.ts`

`normalizeRecord()` fonksiyonuna geriye uyumlu default'lar eklendi:

```typescript
isDeleted: rawRecord.isDeleted === true,
deletedAtMs: typeof rawRecord.deletedAtMs === 'number' ? rawRecord.deletedAtMs : null,
createdAtMs: typeof rawRecord.createdAtMs === 'number' ? rawRecord.createdAtMs : now,
updatedAtMs: typeof rawRecord.updatedAtMs === 'number' ? rawRecord.updatedAtMs : now,
```

## 7) Sync KatmanÄ±

Dosya: `ritim/lib/supabase/sync.ts`

- `CloudRecord` tipine `is_deleted`, `deleted_at`, `created_at` eklendi
- `toCloudRecord` mapping gÃ¼ncellendi:
  ```typescript
  is_deleted: record.isDeleted,
  deleted_at: record.deletedAtMs ? new Date(record.deletedAtMs).toISOString() : null,
  created_at: new Date(record.createdAtMs).toISOString(),
  updated_at: new Date(record.updatedAtMs).toISOString(),
  ```
- `deleteRecordFromCloud` fonksiyonu **tamamen silindi**

## 8) Supabase Migration

```sql
ALTER TABLE public.daily_records
  ADD COLUMN IF NOT EXISTS is_deleted boolean NOT NULL DEFAULT false,
  ADD COLUMN IF NOT EXISTS deleted_at timestamptz NULL,
  ADD COLUMN IF NOT EXISTS created_at timestamptz NOT NULL DEFAULT now();
-- updated_at zaten mevcuttu
```

## 9) Ek: GÃ¼n Silme Dialog'unda Deneme Notu

Dosyalar: `ritim/screens/HomeScreen.tsx`, `ritim/screens/WeekScreen.tsx`

GÃ¼n silme onay dialog'unda, o gÃ¼ne ait deneme varsa bilgilendirme notu gÃ¶steriliyor:
> "Bu gÃ¼ne ait N deneme silinmeyecek, Denemeler ekranÄ±ndan yÃ¶netebilirsiniz."

ğŸ“ DeÄŸiÅŸtirilen Dosyalar

| Dosya | DeÄŸiÅŸiklik |
|-------|-----------|
| `ritim/state/records.tsx` | DailyRecord + DailyRecordInput tipleri, reducer tombstone, tÃ¼m selector filtreleri, removeRecord, upsertRecord |
| `ritim/lib/storage/recordsStorage.ts` | normalizeRecord geriye uyumlu default'lar |
| `ritim/lib/supabase/sync.ts` | CloudRecord tipi, toCloudRecord mapping, deleteRecordFromCloud silindi |
| `ritim/screens/Onboarding2Screen.tsx` | DailyRecord import kaldÄ±rÄ±ldÄ± (DailyRecordInput tip Ã§Ä±karÄ±mÄ±) |
| `ritim/screens/HomeScreen.tsx` | Silme dialog'unda deneme notu |
| `ritim/screens/WeekScreen.tsx` | Silme dialog'unda deneme notu |
| Supabase migration | `is_deleted`, `deleted_at`, `created_at` kolonlarÄ± |

âœ… DoÄŸrulama (Acceptance)

- [x] GÃ¼n silindiÄŸinde localden hard delete yapÄ±lmÄ±yor, `isDeleted: true` olarak kalÄ±yor
- [x] Silinen gÃ¼n UI'da gÃ¶rÃ¼nmÃ¼yor
- [x] Silme iÅŸlemi cloud'a tombstone upsert olarak gÃ¶nderiliyor
- [x] AynÄ± gÃ¼ne yeniden kayÄ±t girilebiliyor (tombstone restore + overwrite)
- [x] Streak ve dot hesaplarÄ± silinen gÃ¼nleri saymÄ±yor
- [x] `selectHasAnyRecords`, `getTrackRange` silinen kayÄ±tlarÄ± dikkate almÄ±yor
- [x] ExamRecord ile silme mantÄ±ÄŸÄ± birebir aynÄ± pattern
- [x] Eski veriler (tombstone alanlarÄ± olmayan) geriye uyumlu ÅŸekilde yÃ¼kleniyor
- [x] TypeScript hatasÄ±z derleniyor

âŒ Kapsam DÄ±ÅŸÄ±

- GÃ¼n geri alma (undelete) UI'Ä±
- KoÃ§ tarafÄ±nda silinen gÃ¼nleri gÃ¶sterme
- Sync conflict resolution geliÅŸtirmeleri
- `syncInitialLast30Days` tombstone kayÄ±tlarÄ± dahil etme (edge case, ayrÄ± ticket)
