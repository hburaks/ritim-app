T2.7.1 â€” Exam Name + Ders BazlÄ± Skor (subjectScores) DesteÄŸi

Durum: TAMAMLANDI

ğŸ¯ AmaÃ§

"Deneme" (Exam) sistemini iki yÃ¶nden geliÅŸtirmek:

1. KullanÄ±cÄ±nÄ±n denemelere opsiyonel isim verebilmesi â€” Ä°sim girilmezse otomatik Ã¼retilir.
2. FULL (Genel) denemelerde her ders iÃ§in ayrÄ± doÄŸru/yanlÄ±ÅŸ/boÅŸ giriÅŸi yapÄ±labilmesi â€” Global toplam skorlar otomatik hesaplanÄ±r.

Mevcut BRANCH deneme akÄ±ÅŸÄ± aynen korunur.

### Uygulama KararlarÄ± (Plan Ticket'tan Sapmalar)

- **Clean Start** yaklaÅŸÄ±mÄ± benimsendi: Legacy veri uyumluluÄŸu yapÄ±lmadÄ±.
- Supabase `exam_records` tablosu DROP + RECREATE ile sÄ±fÄ±rdan oluÅŸturuldu (ALTER yerine).
- **`netTotal` alanÄ± bilinÃ§li olarak kaldÄ±rÄ±ldÄ±** â€” Net hiÃ§bir yerde saklanmaz, her zaman `calculateNet()` ile anlÄ±k hesaplanÄ±r.
- `sumSubjectScores()` helper'Ä± `trackId` parametresi almaz, sadece toplam D/Y/B dÃ¶ndÃ¼rÃ¼r.
- Storage katmanÄ±nda legacy alan dÃ¶nÃ¼ÅŸÃ¼mÃ¼ (eski `correct/wrong/blank` â†’ yeni) yapÄ±lmaz; eski veriler geÃ§ersiz kabul edilir.

ğŸ”§ Kapsam

- ExamRecord modelinin geniÅŸletilmesi
- FULL deneme UI formunun ders bazlÄ± D/Y/B'ye Ã§evrilmesi
- Opsiyonel isim input'u + otomatik sÄ±nav ismi Ã¼retimi
- subjectScores â†’ toplam skorlarÄ±n otomatik hesaplanmasÄ±
- Supabase tablo drop & recreate + RLS
- Sync katmanÄ± gÃ¼ncellenmesi
- ExamsScreen breakdown gÃ¶rÃ¼nÃ¼mÃ¼

ğŸ§© TEKNÄ°K TASARIM (Uygulanan)

## 1) Type GÃ¼ncellemesi

Dosya: `ritim/types/exam.ts`

```typescript
export type ExamRecord = {
  id: string
  trackId: TrackId
  date: string          // YYYY-MM-DD
  type: ExamType
  subjectKey?: string   // sadece BRANCH
  name?: string         // opsiyonel kullanÄ±cÄ± ismi

  correctTotal: number
  wrongTotal: number
  blankTotal: number

  subjectScores?: Record<string, {
    correct: number
    wrong: number
    blank: number
  }>

  durationMinutes?: number

  isDeleted: boolean
  deletedAtMs?: number | null
  createdAtMs: number
  updatedAtMs: number
}
```

Helper'lar:

- `calculateNet(trackId, correct, wrong)` â€” LGS /3, TYT-AYT /4
- `sumSubjectScores(scores)` â€” subjectScores'tan correctTotal/wrongTotal/blankTotal hesaplar (net dahil deÄŸil)

## 2) Otomatik Ä°sim Ãœretimi

Dosya: `ritim/lib/exams/examName.ts`

- `generateExamName(exam, trackId, existingNames)` â€” Otomatik isim Ã¼retir
- `getExamDisplayName(exam, trackId, existingNames)` â€” `exam.name` varsa onu, yoksa otomatik ismi dÃ¶ndÃ¼rÃ¼r

Kurallar:
- FULL: `"LGS 8 Genel Deneme â€“ 12 Mar"`
- BRANCH: `"Matematik Denemesi â€“ 12 Mar"`
- Ã‡akÄ±ÅŸma: `"... (2)"`, `"... (3)"`

Tarih formatÄ± kÄ±saltÄ±lmÄ±ÅŸ ay isimleri kullanÄ±r (Oca, Åub, Mar, ...).

## 3) Storage Normalization

Dosya: `ritim/lib/storage/examsStorage.ts`

- Yeni model alanlarÄ± normalize edilir: `correctTotal`, `wrongTotal`, `blankTotal`, `name`, `subjectScores`
- `normalizeSubjectScores()` helper'Ä± eklendi â€” geÃ§ersiz entry'leri filtreler
- Legacy alanlardan (`correct/wrong/blank`) dÃ¶nÃ¼ÅŸÃ¼m yapÄ±lmaz â€” eski kayÄ±tlar geÃ§ersiz kabul edilir

## 4) Supabase Migration (Clean Start)

Tablo tamamen silinip yeniden oluÅŸturuldu:

```sql
DROP TABLE IF EXISTS public.exam_records;

CREATE TABLE public.exam_records (
  id text PRIMARY KEY,
  user_id uuid NOT NULL REFERENCES auth.users(id),
  track_id text NOT NULL,
  date date NOT NULL,
  type text NOT NULL CHECK (type IN ('FULL', 'BRANCH')),
  subject_key text NULL,
  name text NULL,
  subject_scores jsonb NULL,
  correct_total int NOT NULL DEFAULT 0,
  wrong_total int NOT NULL DEFAULT 0,
  blank_total int NOT NULL DEFAULT 0,
  duration_minutes int NULL,
  is_deleted boolean NOT NULL DEFAULT false,
  deleted_at timestamptz NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX idx_exam_user_track_date
  ON public.exam_records(user_id, track_id, date DESC);
```

RLS Policy'ler:
- `"Users can manage own exam records"` â€” ALL, `user_id = auth.uid()`
- `"Coaches can read student exam records"` â€” SELECT, `coach_students` tablosu Ã¼zerinden

**Not:** `net_total` kolonu bilinÃ§li olarak eklenmedi â€” net her zaman client'ta hesaplanÄ±r.

## 5) Sync KatmanÄ± GÃ¼ncellemesi

Dosya: `ritim/lib/supabase/sync.ts`

CloudExamRecord yeni alanlarÄ± iÃ§erir:
- `name`, `subject_scores`, `correct_total`, `wrong_total`, `blank_total`

Eski kolonlara (`correct`, `wrong`, `blank`, `net_total`) veri yazÄ±lmaz.

## 6) DayEntrySheet UI GÃ¼ncellemesi

Dosya: `ritim/components/DayEntrySheet.tsx`

**FULL seÃ§iliyken:**
- Her ders iÃ§in ayrÄ± D/Y/B stepper'larÄ± gÃ¶sterilir
- Ãœstte canlÄ± toplam banner: `"Toplam: 40D 8Y 2B â€“ 37.3 net"`

**BRANCH seÃ§iliyken:**
- Tek D/Y/B satÄ±rÄ± aynen korunur

**Ä°sim input:**
- Opsiyonel TextInput: `"Deneme AdÄ± (isteÄŸe baÄŸlÄ±)"`

**Save mantÄ±ÄŸÄ±:**
- FULL: `subjectScores` kaydedilir, totals `sumSubjectScores()` ile hesaplanÄ±r
- BRANCH: girilen D/Y/B â†’ totals olarak kaydedilir

**Liste satÄ±rlarÄ±:**
- Her deneme: `[Deneme Ä°smi]` + `40D 8Y 2B â€“ 37.3 net`

## 7) ExamsScreen GÃ¼ncellemesi

Dosya: `ritim/screens/ExamsScreen.tsx`

- Kart baÅŸlÄ±ÄŸÄ±nda `getExamDisplayName()` ile isim gÃ¶sterimi
- Toplam satÄ±rÄ±: D/Y/B + net
- FULL denemelerde breakdown bÃ¶lÃ¼mÃ¼ (border-top ile ayrÄ±lmÄ±ÅŸ):
  ```
  Matematik: 30D 5Y 5B â€“ 28.3 net
  TÃ¼rkÃ§e:    20D 3Y 2B â€“ 19.2 net
  ```
- SÄ±fÄ±r verili dersler breakdown'da gÃ¶sterilmez

## 8) State GÃ¼ncellemesi

Dosya: `ritim/state/exams.tsx`

- `AddExamInput` type alias'Ä± eklendi
- `addExam` imzasÄ± yeni modele uyumlu hale getirildi

ğŸ“ Etkilenen Dosyalar

| Dosya | DeÄŸiÅŸiklik |
|-------|-----------|
| `ritim/types/exam.ts` | `correct/wrong/blank` â†’ `correctTotal/wrongTotal/blankTotal`, `name?`, `subjectScores?`, `sumSubjectScores()` |
| `ritim/lib/exams/examName.ts` | **Yeni** â€” `generateExamName()`, `getExamDisplayName()` |
| `ritim/lib/storage/examsStorage.ts` | Yeni model normalization, `normalizeSubjectScores()` |
| `ritim/lib/supabase/sync.ts` | CloudExamRecord yeni alanlar, eski kolonlar kaldÄ±rÄ±ldÄ± |
| `ritim/components/DayEntrySheet.tsx` | FULL â†’ ders bazlÄ± D/Y/B, isim input, canlÄ± toplam banner |
| `ritim/screens/ExamsScreen.tsx` | Ä°sim gÃ¶sterimi, FULL breakdown bÃ¶lÃ¼mÃ¼ |
| `ritim/state/exams.tsx` | `AddExamInput` type, `addExam` imzasÄ± |
| Supabase migration | Tablo drop & recreate, RLS policy'ler |

âœ… DoÄŸrulama (Acceptance)

- [x] FULL denemelerde ders bazlÄ± D/Y/B girilebiliyor
- [x] BRANCH deneme davranÄ±ÅŸÄ± deÄŸiÅŸmemiÅŸ
- [x] Toplam skorlar subjectScores'tan doÄŸru hesaplanÄ±yor
- [x] Net hesaplama doÄŸru (LGS /3, TYT-AYT /4)
- [x] KullanÄ±cÄ± isim girebiliyor
- [x] Ä°sim girilmezse otomatik Ã¼retiliyor
- [x] AynÄ± gÃ¼n Ã§akÄ±ÅŸan isimlere (2), (3) ekleniyor
- [x] ExamsScreen'de breakdown gÃ¶rÃ¼nÃ¼yor
- [x] Supabase'e yeni alanlar doÄŸru sync oluyor
- [x] `netTotal` hiÃ§bir yerde saklanmÄ±yor, her zaman hesaplanÄ±yor
- [x] TypeScript derlemesi hatasÄ±z

âŒ Kapsam DÄ±ÅŸÄ±

- KoÃ§ dashboard ekranlarÄ±
- Ä°statistik raporlamasÄ±
- Offline-first conflict Ã§Ã¶zÃ¼m stratejileri
- Topics verisinin denemeye baÄŸlanmasÄ±
