## T2.6.2 - Track Bazli Gun Kayitlari ve Haftalar Gorunumu

> **Durum: TAMAMLANDI**
> Uygulama ve Supabase migration'i uygulandi. Konular ekrani ile ders kaynaklarini birebir aynilama isi T2.6.3'e ayrildi.

### Amac
T2.6 ile gelen aktif track yapisini gunluk kayitlar, Home, Days, Week ve sync katmanina tam olarak yansitmak.

Bu ticket ile:
- Gun kayitlari track'e baglandi.
- Ayni gunde farkli track'ler icin ayri kayit tutulabilir hale geldi.
- Home/Days/Week yalnizca aktif track verisini gosterecek sekilde guncellendi.
- Supabase sync conflict anahtari track-aware yapildi.

### Uygulanan Kararlar

1. Kayit kimligi `trackId + date` oldu.
2. Bir kullanici, bir gunde bir track icin en fazla bir kayit tutar.
3. Ayni gunde farkli track kayitlari birbirini ezmez.
4. Edit akisinda kaydin kendi `trackId` degeri korunur.
5. Create akisinda `trackId = settings.activeTrack` kullanilir.

### Uygulanan Degisiklikler

#### 1) DailyRecord modeli
- `DailyRecord` icine `trackId: TrackId` zorunlu alan olarak eklendi.
- Dosya: `ritim/state/records.tsx`

#### 2) Local storage key yapisi
- Kayit key formati: `{trackId}__{date}`
- `makeRecordKey(trackId, date)` helper eklendi.
- Track-aware fonksiyonlar eklendi:
  - `getRecord(trackId, date)`
  - `upsertRecord(record)`
  - `listRecordsByTrack(trackId)`
- Legacy kayitlar parse edilirken track olmayan veriler guvenli fallback ile normalize edildi.
- Dosya: `ritim/lib/storage/recordsStorage.ts`

#### 3) Records store API (track-aware)
- Yeni API:
  - `getRecord(trackId, date)`
  - `removeRecord(trackId, date)`
  - `selectTodayRecord(trackId, dateKey?)`
  - `selectWeekDots(trackId, weekStartKey?)`
  - `getTrackRange(trackId)`
  - `getTrackStreak(trackId, fromDateKey?)`
- `getWeekStartKey()` helper eklendi.
- Dosya: `ritim/state/records.tsx`

#### 4) Onboarding ilk kayit
- Ilk kayit olusturulurken `trackId: settings.activeTrack` eklendi.
- `activeTrack` yoksa kaydetme ve sheet acma engellendi.
- Dosya: `ritim/screens/Onboarding2Screen.tsx`

#### 5) DayEntrySheet davranisi
- `effectiveTrack` mantigi eklendi:
  - Edit: kaydin track'i
  - Create: aktif track
- `trackId` prop'u eklendi.
- `effectiveTrack` yoksa sheet kapanir (guard).
- Track degisince acik sheet kapanma davranisi korundu.
- Dosya: `ritim/components/DayEntrySheet.tsx`

#### 6) Home / Days / Week track filtreleme
- Home:
  - Bugun kaydi ve haftalik dotlar aktif track'ten okunur.
  - Save/Delete track-aware kimlikle yapilir.
  - Dosya: `ritim/screens/HomeScreen.tsx`
- Days:
  - Sadece aktif track kayitlari listelenir.
  - Ilk acilis: `visibleWeeks = min(6, totalWeeksForTrack)`
  - Infinite scroll: her seferde `+4`
  - Durma kosulu: `visibleWeeks >= totalWeeksForTrack`
  - Dosya: `ritim/screens/DaysScreen.tsx`
- Week:
  - Gun satiri lookup `getRecord(activeTrack, date)` ile yapilir.
  - Edit/Delete track-aware kimlikle calisir.
  - Dosya: `ritim/screens/WeekScreen.tsx`

#### 7) Supabase sync guncellemesi
- `daily_records` upsert payload'ina `track_id` eklendi.
- `onConflict` guncellendi:
  - Eski: `user_id,date`
  - Yeni: `user_id,track_id,date`
- Cloud delete guncellendi:
  - `user_id + track_id + date`
- Dosya: `ritim/lib/supabase/sync.ts`

#### 8) Initial sync cagri imzasi
- `syncInitialLast30Days()` artik map yerine `DailyRecord[]` aliyor.
- Entegrasyon guncellendi.
- Dosya: `ritim/screens/CoachConnectScreen.tsx`

#### 9) Supabase migration
- Dosya: `docs/sql/2026-02-10-daily-records-track-id.sql`
- Icerik:
  - `track_id` kolonu ekleme (IF NOT EXISTS)
  - null track satirlarini fallback ile doldurma
  - `track_id` NOT NULL
  - eski unique constraint kaldirma
  - yeni unique: `(user_id, track_id, date)`

### Acceptance Kriterleri

- [x] Gun kaydi olusturulurken `trackId` ekleniyor.
- [x] Ayni gunde iki farkli track icin iki kayit tutulabiliyor.
- [x] Gunler ekrani yalnizca aktif track kayitlarini gosteriyor.
- [x] Track degisince ilgili kayit gorunumu track'e gore degisiyor.
- [x] Gecmis gun duzenlemede dogru track'in dersleri aciliyor.
- [x] Track degisince acik DayEntrySheet kapaniyor.
- [x] Supabase sync conflict key: `user_id,track_id,date`.
- [x] Infinite scroll track bazli stop kurali ile calisiyor.
- [x] Ilk acilista `max 6 hafta` kurali uygulaniyor.

Not:
- Home'da gorunur bir streak metni yok. Track bazli streak hesabi store seviyesinde (`getTrackStreak`) hazirlandi.

### Kapsam Disi / T2.6.3'e Ayrilan

- Konular ekrani filtre chipleri ile DayEntrySheet ders seceneklerinin birebir tek kaynaktan beslenmesi.
- Topics veri modelinin track subject setiyle tam senkron hale getirilmesi.

Bu basliklar T2.6.3 ticket'inda ele alinacak.
